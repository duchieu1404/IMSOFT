<% include ../partial/admin_header.ejs %>
<!-- Content Header (Page header)-->
<section class="content-header">
  <h1>Server Config<small>Configuration</small></h1>
  <ol class="breadcrumb">
    <li><a href="#"><i class="fa fa-dashboard"></i>Configuration</a></li>
    <li class="active">Event popup</li>
  </ol>
</section>


<!-- Main content-->
<section class="content">

  <div class="col-md-12 col-sm-12 col-xs-12">
    <div class="x_panel">
      <div class="x_title">
        <div class="clearfix"></div>
      </div>

      <div class="box box-info">
        <div class="box-header with-border">
          <h3 class="box-title">Search Event Popup Form</h3>
        </div>

        <div class="box-footer">
          <div>
            <input type="button"
                   data-toggle="modal"
                   data-target=".edit-config-modal-lg" class="btn btn-success" value="Add Event Popup" onclick="onClick_btnAddNewEvent()"/>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="col-md-12 col-sm-12 col-xs-12">
    <div class="x_panel">
      <div class="x_content">
        <p class="text-muted font-13 m-b-30">
        </p>
        <table id="datatable" class="table table-striped table-bordered">
          <thead>
          <tr>
            <th>Action </th>
            <th>Id</th>
            <th>name</th>
            <th>show_map_count</th>
            <th>order</th>
            <th>os_type</th>
            <th>version</th>
            <th>status</th>
            <th>show from</th>
            <th>show to</th>
            <th>check_type</th>
            <th>force_view</th>
            <th>asset_url</th>
            <th>bundle_name</th>
            <th>template_type</th>
            <th>img_url</th>
            <th>data</th>
            <th>Promote IAP</th>
            <th>Promote Bundle</th>
            <th>Only Users</th>
            <th>Ignore Users</th>
            <th>Show Condition</th>
          </tr>
          </thead>
          <tbody>
          <% dataConfigs.forEach(function(conf) { %>
          <tr id = "dataServerConfig_<%= conf.id %>">
            <th>
              <button type="button"
                      class="btn btn-primary"
                      data-toggle="modal"delete_event_popup
                      data-target=".edit-config-modal-lg"
                      onclick="btnEditClicked(<%= conf.id %>)"
              >Edit</button>

              <button type="button"
                      class="btn btn-danger"
                      data-toggle="modal"
                      data-target=".delete_user-modal-lg"
                      onclick="btnDeleteEventPopup(<%= conf.id %>)"
              >Delete</button>

            </th>

            <th id = "ds_<%= conf.id %>_dts_id"><%= conf.id %></th>
            <th id = "ds_<%= conf.id %>_dts_note"><%= conf.note %></th>
            <th id = "ds_<%= conf.id %>_dts_show_map_count"><%= conf.show_map_count %></th>
            <th id = "ds_<%= conf.id %>_dts_order_by"><%= conf.order_by %></th>
            <th id = "ds_<%= conf.id %>_dts_os_type"><%= conf.os_type %></th>
            <th id = "ds_<%= conf.id %>_dts_version"><%= conf.version %></th>
            <th id = "ds_<%= conf.id %>_dts_status"><%= conf.status %></th>
            <th id = "ds_<%= conf.id %>_dts_show_from"><%= conf.show_from %></th>
            <th id = "ds_<%= conf.id %>_dts_show_to"><%= conf.show_to %></th>
            <th id = "ds_<%= conf.id %>_dts_check_type"><%= conf.check_type %></th>
            <th id = "ds_<%= conf.id %>_dts_force_view"><%= conf.force_view %></th>
            <th id = "ds_<%= conf.id %>_dts_asset_url"><%= conf.asset_url %></th>
            <th id = "ds_<%= conf.id %>_dts_bundle_name"><%= conf.bundle_name %></th>
            <th id = "ds_<%= conf.id %>_dts_template_type"><%= conf.template_type %></th>
            <th id = "ds_<%= conf.id %>_dts_img_url"><%= conf.img_url %></th>
            <th id = "ds_<%= conf.id %>_dts_data"><%= conf.data %></th>
            <th id = "ds_<%= conf.id %>_dts_promote_iap_cnf"><%= conf.promote_iap_cnf %></th>
            <th id = "ds_<%= conf.id %>_dts_promote_bundle_cnf"><%= conf.promote_bundle_cnf %></th>
            <th id = "ds_<%= conf.id %>_dts_only_users"><%= conf.only_users %></th>
            <th id = "ds_<%= conf.id %>_dts_ignore_users"><%= conf.ignore_users %></th>
            <th id="ds_<%= conf.id %>_dts_show_condition"><%= conf.show_condition %></th>

          </tr>
          <% }); %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="modal fade edit-config-modal-lg" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span>
          </button>
          <h4 class="modal-title" id="myModalLabel">Edit Config</h4>
        </div>


        <div class="modal-body">

          
          <form action="/config/event_popup" method="post" id="demo-form2" data-parsley-validate class="form-horizontal form-label-left">

            <!-- === -->

            <div class="form-group">
            
              <label class="control-label col-md-2 col-sm-3 col-xs-4">Id</label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <input type="text" class="form-control" placeholder="Id" id = "edt_id" name="edt_id" value="" readonly="readonly">
              </div>
            </div>

            <div class="form-group">
            
              <label class="control-label col-md-2 col-sm-2 col-xs-2">Type</label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <select class="form-control" id = "event_popup_type" class="event_popup_type" onchange="onEventPopupTypeEvent()">
                  <option value="0">DOWNLOAD</option>
                  <option value="1">TEMPLATE</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4">OS type</label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <select class="form-control" id = "edt_os_type" name="edt_os_type">
                  <option value="[&quot;ANDROID&quot;]">ANDROID</option>
                  <option value="[&quot;IPhonePlayer&quot;,&quot;IOS&quot;,&quot;IPAD&quot;]">IOS</option>
                  <option value="[&quot;WindowsEditor&quot;]">WINDOWS</option>
                  <option value="[&quot;IPhonePlayer&quot;,&quot;IOS&quot;,&quot;IPAD&quot;,&quot;ANDROID&quot;,&quot;WindowsEditor&quot;]">ALL</option>
                </select>
                <!-- <input type="text" class="form-control" placeholder="ANDROID IOS WindowEditor % ( all)" id = "edt_os_type" name="edt_os_type" value = "%"> -->
              </div>
            </div>

            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4">Version</label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <input type="text" class="form-control" placeholder="Set % for all ( use select like )" id = "edt_version" name="edt_version" value = "%">
              </div>
            </div>


            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4">Show From (Date time)<font color="red"> (*)</font></label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <input type="text" class="form-control" id = "edt_show_from" name="edt_show_from" value = "" placeholder="yyyy/mm/dd hh:mm:ss">
              </div>
            </div>

            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4">Show To (Date time)<font color="red"> (*)</font></label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <input type="text" class="form-control" id = "edt_show_to" name="edt_show_to" value = "" placeholder="yyyy/mm/dd hh:mm:ss">
              </div>
            </div>

            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4">Condition<font color="red"> (*)</font></label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <select class="form-control" id = "edt_check_type" name="edt_check_type">
                  <option value="0">0. NONE</option>
                  <option value="1">1. DON'T SHOW</option>
                  <option value="2">2. DON'T SHOW TODAY</option>
                </select>
                <!-- <input type="text" class="form-control" placeholder="1 : has don't show, 2 : don't show today" id = "edt_check_type" name="edt_check_type" value = ""> -->
              </div>
            </div>
            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4">Force view<font color="red"> (*)</font></label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <select class="form-control" id = "edt_force_view" name="edt_force_view">
                  <option value="0">0. NO</option>
                  <option value="1">1. YES</option>
                </select>
                <!-- <input type="text" class="form-control" placeholder="1: force view, 0 : can't show if check don't show" id = "edt_force_view" name="edt_force_view" value = ""> -->
              </div>
            </div>

            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4">Asset Url<font color="red"> (*)</font></label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <input type="text" class="form-control" placeholder="Url download asset bundle of popup" id = "edt_asset_url" name="edt_asset_url" value = "">
              </div>
            </div>
            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4">Bundle name<font color="red"> (*)</font></label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <input type="text" class="form-control" placeholder="Name of asset bundle when export from unity" id = "edt_bundle_name" name="edt_bundle_name" value = "">
              </div>
            </div>

            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4">Template Popup<font color="red"> (*)</font></label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <select class="form-control" id = "edt_template_type" name="edt_template_type" onchange="onTemplateTypeChange()">
                  <option value="0">Select a Value</option>
                  <option value="1">1. Show 1 button with condition</option>
                  <option value="2">2. Show 1 button without condition</option>
                  <option value="3">3. Show 2 button with condition</option>
                  <option value="4">4. Show 2 button without conditon</option>
                </select>
                <!-- <input type="text" class="form-control" placeholder="Template ID if use template instead of export new asset bundle" id = "edt_template_type" name="edt_template_type" value = "0"> -->
              </div>
            </div>

            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4">Image Url<font color="red"> (*)</font></label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <input type="text" class="form-control" placeholder="Background image link " id = "edt_img_url" name="edt_img_url" value = "">
              </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-2 col-sm-3 col-xs-4">Show Condition<font color="red"> (*)</font></label>
                <div class="col-md-9 col-sm-9 col-xs-12">
                  <textarea type="text" class="form-control" rows="5" placeholder="Enter json condition" id="edt_show_condition"
                    name="edt_show_condition" value=""></textarea>
                </div>
            </div>

            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4">Data<font color="red"> (*)</font></label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <textarea type="text" class="form-control" rows="5" placeholder="Enter json data config for template" id = "edt_data" name="edt_data" value = ""></textarea>
              </div>
            </div>

            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4" data-toggle="tooltip" title="Status!">Status</label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <select class="form-control" id = "edt_status" name="edt_status">
                  <option value="1" selected="selected">1. ENABLE</option>
                  <option value="0">0. DISABLE</option>
                </select>
                <!-- <input type="text" class="form-control" placeholder="0 : disable , 1 : enable" id = "edt_status" name="edt_status" value = "0"> -->
              </div>
            </div>

            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4">Name</label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <input  class="form-control col-md-5 col-xs-10" type="text" id = "edt_note" name="edt_note" value="">
              </div>
            </div>

            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4">Order</label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <select class="form-control" id = "edt_order" name="edt_order">
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                </select>
                <!-- <input  class="form-control col-md-5 col-xs-10" type="text" id = "edt_order" name="edt_order" value=""> -->
              </div>
            </div>

            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4">Show Map Count</label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <input  class="form-control col-md-5 col-xs-10" type="text" id = "edt_show_map_count" name="edt_show_map_count" value="">
              </div>
            </div>

            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4">Only Users</label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <input  class="form-control col-md-5 col-xs-10" placeholder="This event only show for these users" type="text" id = "edt_only_users" name="edt_only_users" value="">
              </div>
            </div>

            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4">Ignored Users</label>
              <div class="col-md-9 col-sm-9 col-xs-12">
                <input  class="form-control col-md-5 col-xs-10" placeholder="This event is ignored for these users" type="text" id = "edt_ignore_users" name="edt_ignore_users" value="">
              </div>
            </div>

              <div class="form-group">
                  <label class="control-label col-md-2 col-sm-3 col-xs-4">Promote IAP</label>
                  <div class="col-md-9 col-sm-9 col-xs-12">
                      <textarea  class="form-control col-md-5 col-xs-10" rows="5" type="text" id = "edt_promo_iap" name="edt_promo_iap" value=""></textarea>
                  </div>
              </div>

              <div class="form-group">
                  <label class="control-label col-md-2 col-sm-3 col-xs-4">Promote Bundle</label>
                  <div class="col-md-9 col-sm-9 col-xs-12">
                      <textarea  class="form-control col-md-5 col-xs-10" rows="5" type="text" id = "edt_promo_bundle" name="edt_promo_bundle" value=""></textarea>
                  </div>
              </div>

            <div class="modal-footer">
              <input type="submit" class="btn btn-default" data-dismiss="modal" value="Close">
              <input type="submit" class="btn btn-primary" value="Save changes">
              <input type="button" onclick="btnSaveAsNewClicked()" class="btn btn-primary" id = "btn_save_as_new" value="Save as new">
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>



  <div class="modal fade delete_user-modal-lg" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span>
          </button>
          <h4 class="modal-title" id="myModalLabel">Do you want to delete this user?</h4>
        </div>
        <div class="modal-body">

          <form action="/config/delete_event_popup" method="post" id="delete_user-form2" data-parsley-validate class="form-horizontal form-label-left">

            <!-- === -->

            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4">Event popup Id </label>

              <div class="col-md-4 col-sm-9 col-xs-12">
                <input type="text" class="form-control" placeholder="Version Id" id = "delete_edt_Id" name="delete_edt_Id" value="" readonly="readonly">
              </div>

              <label class="control-label col-md-2 col-sm-3 col-xs-4">Device id</label>

              <div class="col-md-3 col-sm-9 col-xs-12">
                <input type="text" class="form-control" placeholder="Device id" id = "delete_edt_device_id" name="delete_edt_device_id" value = "0" readonly="readonly">
              </div>
            </div>

            <div class="form-group">
              <label class="control-label col-md-2 col-sm-3 col-xs-4">Type "delete" to confirm </label>
              <div class="col-md-4 col-sm-9 col-xs-12">
                <input type="text" class="form-control" placeholder="delete" id = "delete_text_confirm" name="delete_text_confirm" value="">
              </div>
            </div>

            <div class="modal-footer">
              <input type="button" class="btn btn-default" data-dismiss="modal" value="Close" id = "modalDelete">
              <input type="button" class="btn btn-danger" value="Delete" onclick="btnDoDeleteEventPopup()">
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>


</section>

<script type="text/javascript">

  var btnDeleteEventPopup = function(serverId){
    $('#delete_edt_Id').val($('#ds_'+serverId+'_dts_id').html());
    $('#delete_edt_device_id').val($('#ds_'+serverId+'_dts_device_id').html());
  }

  var btnDoDeleteEventPopup = function(){

    if( $('#delete_text_confirm').val() !='delete'){
      alert("Please type delete to confirm you want to delete that event popup");
      $('#delete_text_confirm').focus();
      return;
    }

    let user_id_delete =  $('#delete_edt_Id').val();
    $.ajax({
      type: "POST",
      url: '/config/delete_event_popup',
      data: $( "#delete_user-form2" ).serialize(),
      success: function(dataResult,textStatus,jqXHR){
        console.log(dataResult);
        if(dataResult.status ==0){
          $('#dataServerConfig_'+user_id_delete).remove();
          $(".delete_user-modal-lg .close").click()
          alert("Delete success");
        }
      },
      dataType: 'json'
    });
  }


  var btnSaveAsNewClicked = function()
  {    
    $('#edt_id').val(-1);
    $('#btn_save_as_new[value]').val("Done");
  }

  var btnEditClicked = function(serverId){

   

    $('#edt_id').val($('#ds_'+serverId+'_dts_id').html());
    $('#edt_os_type').val($('#ds_'+serverId+'_dts_os_type').html());
    $('#edt_version').val($('#ds_'+serverId+'_dts_version').html());

    $('#edt_show_from').val($('#ds_'+serverId+'_dts_show_from').html());
    $('#edt_show_to').val($('#ds_'+serverId+'_dts_show_to').html());
    $('#edt_check_type').val($('#ds_'+serverId+'_dts_check_type').html());
    $('#edt_force_view').val($('#ds_'+serverId+'_dts_force_view').html());
    $('#edt_asset_url').val($('#ds_'+serverId+'_dts_asset_url').html());
    $('#edt_bundle_name').val($('#ds_'+serverId+'_dts_bundle_name').html());

    $('#edt_template_type').val($('#ds_'+serverId+'_dts_template_type').html());
    $('#edt_img_url').val($('#ds_'+serverId+'_dts_img_url').html());
    $('#edt_data').val($('#ds_'+serverId+'_dts_data').html());

    $('#edt_status').val($('#ds_'+serverId+'_dts_status').html());
    $('#edt_note').val($('#ds_'+serverId+'_dts_note').html());
    $('#edt_order').val($('#ds_'+serverId+'_dts_order_by').html());
    $('#edt_only_users').val($('#ds_'+serverId+'_dts_only_users').html());
    $('#edt_ignore_users').val($('#ds_'+serverId+'_dts_ignore_users').html());

    $('#edt_show_map_count').val($('#ds_'+serverId+'_dts_show_map_count').html());
    $('#edt_promo_iap').val($('#ds_'+serverId+'_dts_promote_iap_cnf').html());
    $('#edt_promo_bundle').val($('#ds_'+serverId+'_dts_promote_bundle_cnf').html());
    $('#edt_show_condition').val($('#ds_' + serverId + '_dts_show_condition').html());

    $('#btn_save_as_new[value]').val("Save as new");
    
    console.log("data :" +$('#edt_asset_url').val());

    if($('#edt_asset_url').val() == "" || $('#edt_asset_url').val() == undefined)
    {
      onSelectTemplateType();
    }
    else
    {
      onSelectDownloadType();
    }

  }

  var onClick_btnAddNewEvent = function(){
    $('#edt_id').val(-1);
    $('#edt_os_type').val('["ANDROID"]');

    $('#edt_show_from').val('');
    $('#edt_show_to').val('');
    //$('#edt_check_type').val('');
    $('#edt_force_view').val('0');
    $('#edt_asset_url').val('');
    $('#edt_bundle_name').val('');
    $('#edt_status').val(1);
    $('#edt_note').val('');

    $('#edt_template_type').val(0);
    $('#edt_img_url').val('');
    $('#edt_data').val('');
    $('#edt_order').val("1");
    $('#edt_only_users').val("");
    $('#edt_ignore_users').val("");

    $('#edt_show_map_count').val(0);
    $('#edt_promo_iap').val("");
    $('#edt_promo_bundle').val("");
    $('#event_popup_type').val(1);
    $('#show_condition').val("");
    
    onEventPopupTypeEvent();

    $('#btn_save_as_new[value]').val("Save as new");


  }
  var onEventPopupTypeEvent = function()
  {
    if($('#event_popup_type').val() == 0)
    {
      onSelectDownloadType();

    }
    else
    {
      onSelectTemplateType();
    }
    // console.log("id : " + $('#edt_id').val());
    // console.log("onEventPopupTypeEvent");

  }

  var onTemplateTypeChange = function()
  {
    return;

      var templateId = $('#edt_template_type').val();

      console.log("onTemplateTypeChange : " +templateId);

      var json;

      switch(parseInt(templateId))
      {
        case 0: 
        $('#edt_data').val("0");
        break;
        case 1: 
        $('#edt_data').val('');
        break;
        case 2: 
        $('#edt_data').val("2");
        break;
        $('#edt_data').val("3");
        break;
        case 2: 
        $('#edt_data').val("4");
        break;
      }

   
      


  }

  var onSelectDownloadType = function()
  {

    $('#edt_template_type').closest('.form-group').hide();

    $('#edt_img_url').closest('.form-group').hide();

    $('#edt_asset_url').closest('.form-group').show();

    $('#edt_bundle_name').closest('.form-group').show();

    $('#edt_data').closest('.form-group').hide();
  

  }

  var onSelectTemplateType = function()
  { 
    $('#edt_template_type').closest('.form-group').show();

    $('#edt_img_url').closest('.form-group').show();

    $('#edt_asset_url').closest('.form-group').hide();

    $('#edt_bundle_name').closest('.form-group').hide();

    $('#edt_data').closest('.form-group').show();
  }


</script>

<% include ../partial/admin_footer.ejs %>